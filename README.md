# Bot Analysis Snapshots

Проект Telegram-бота, который преобразует текстовые запросы пользователя на естественном языке в обращения к базе данных (SQL) и возвращает результаты. Проект контейнеризирован с помощью Docker и включает PostgreSQL, опционально pgAdmin, и сервис приложения на Python.


## Содержание
- Быстрый старт (Docker)
- Настройка токена Telegram-бота
- Архитектура и поток обработки запроса
- Преобразование текста в SQL/код
- Использование LLM: описание схемы данных и промпт
- Полезные команды
- Структура репозитория


## Быстрый старт (Docker)
Требования:
- Docker и Docker Compose установлены

Шаги запуска:
1) Создайте файл окружения с токеном бота (см. ниже раздел «Настройка токена Telegram-бота»).
2) Запустите все сервисы:
   - Windows PowerShell/Command Prompt из корня репозитория:
     - `docker compose up --build`
3) Дождитесь, пока поднимутся контейнеры: база данных, (опционально) pgAdmin и приложение.
4) Бот начнет работу: пересланные/введенные команды в Telegram будут обрабатываться приложением.

Остановка сервисов:
- `docker compose down`

Примечания:
- Данные PostgreSQL сохраняются в volume/директории `.postgres_data` (см. docker-compose.yml).
- Для администрирования БД может использоваться pgAdmin (если включен в docker-compose.yml). Директория `.pgadmin_data` хранит его данные.


## Настройка токена Telegram-бота
Токен должен быть задан как переменная окружения, чтобы контейнер приложения мог его прочитать.

Вариант A (локально через .env):
1) Создайте файл `.env` в корне репозитория со следующим содержимым:
   - `TELEGRAM_BOT_TOKEN=ваш_токен_бота`
2) Убедитесь, что docker-compose.yml читает этот файл (обычно Docker Compose делает это автоматически), либо добавьте env_file в соответствующий сервис.

Вариант B (передача через командную строку):
- `TELEGRAM_BOT_TOKEN=ваш_токен_бота docker compose up --build`

Вариант C (Windows PowerShell):
- `$env:TELEGRAM_BOT_TOKEN="ваш_токен_бота"; docker compose up --build`

Где читается токен:
- В коде используется модуль `config/config.py`, который подхватывает переменные окружения (включая `TELEGRAM_BOT_TOKEN`).
- Файл `main.py` и модуль `bot/` инициализируют и запускают бота, используя значение токена из конфига.


## Архитектура и поток обработки запроса
Высокоуровневая структура:
- `main.py` — точка входа, инициализация конфигурации, подключение к БД и запуск обработчиков Telegram-бот��.
- `bot/handlers/` — обработчики команд и сообщений:
  - `start_help.py` — команды /start и /help
  - `query.py` — обработка пользовательских NL-запросов к данным
  - `other.py` — обработка прочих сообщений
- `bot/services/llm.py` — взаимодействие с LLM: построение промптов, описание схемы, получение/постобработка ответа
- `infrastructure/database/` — работа с БД:
  - `connection.py` — создание подключения/пула к PostgreSQL
  - `query_executor_db.py` — безопасное выполнение SQL и маппинг результатов
- `infrastructure/load_data/` — загрузка тестовых данных (скрипт `load_data.py`, данные `videos.json`)
- `migrations/create_tables.py` — создание таблиц/схемы БД
- `config/config.py` — конфигурация приложения, чтение переменных окружения

Поток запроса (end-to-end):
1) Пользователь отправляет боту текстовый запрос в Telegram.
2) Обработчик из `bot/handlers/query.py` принимает текст и передает его в сервис LLM (`bot/services/llm.py`).
3) Сервис LLM формирует системный и пользовательский промпт, включающий описание схемы БД и инструкции, и отправляет запрос к модели.
4) Модель генерирует SQL (или фрагмент кода), соответствующий пользовательскому намерению.
5) Сервис обращения к БД (`infrastructure/database/query_executor_db.py`) выполняет сгенерированный SQL с защитой от опасных конструкций.
6) Результат форматируется и отправляется пользователю обратно в Telegram.


## Преобразование текста в SQL/код
Подход:
- LLM выступает как планировщик запросов. На вход подается:
  - Краткое описание задачи пользователя
  - Строгое описание схемы (имена таблиц, колонок, типы, связи)
  - Правила генерации безопасного и оптимального SQL (например, только SELECT, лимиты, сортировки)
- На выходе ожидается:
  - Чистый SQL-запрос (без пояснений), либо JSON-структура с полями: `sql`, `parameters`, `explanation` — по договоренности с обработчиком
  - Валидация на стороне приложения (проверка запрещенных ключевых слов, лимитов)

Выполнение:
- `query_executor_db.py` принимает SQL, использует подключение из `connection.py` и возвращает результат как список записей/словари.
- Результат конвертируется в компактный человекочитаемый текст/таблицу, пригодную к отправке в Telegram.

Ошибки и fallback:
- При ошибках парсинга/выполнения SQL возвращается сообщение об ошибке пользователю, и предлагаются альтернативные переформулировки.


## Использование LLM: описание схемы данных и промпт
Описание схемы:
- Схема БД задается в виде текстового блока, собираемого в `bot/services/llm.py` на основе актуальных миграций (`migrations/create_tables.py`).
- В описании перечисляются таблицы, ключи, связи, типы полей и допустимые значения.

Промпт (концепция):
- Системная часть:
  - «Ты - помощник по генерации SQL для PostgreSQL. Генерируй только SQL без комментариев. Используй только перечисленные таблицы и поля. Предпочитай безопасные SELECT, избегай DDL/DML. Добавляй LIMIT по умолчанию (например, 100).»
- Пользовательская часть:
  - Текст запроса пользователя + инлайн описание схемы и несколько примеров (few-shot), если доступны.
- Постобработка:
  - Парсинг ответа, нормализация кавычек/плейсхолдеров, добавление защитных ограничений.

Настройка модели:
- Параметры модели и ключи доступны через переменные окружения, которые читает `config/config.py` и модуль `bot/services/llm.py`.
- Используется внешнее API указаны переменные окружения вида `LLM_API_KEY`.

## Полезные команды
- Запуск/перезапуск контейнеров:
  - `docker compose up --build`
- Остановка:
  - `docker compose down`
- Применение миграций (внутри контейнера приложения, если предусмотрен entrypoint/cmd):
  - автоматически при старте или вручную командой скрипта `python migrations/create_tables.py`
- Загрузка данны��:
  - `python infrastructure/load_data/load_data.py`


## Структура репозитория
- `main.py` точка входа приложения
- `Dockerfile` образ приложения
- `docker-compose.yml` оркестрация сервисов (app, db, pgadmin)
- `config/config.py` конфигурация и переменные окружения
- `bot/handlers/` обработчики Telegram-бота
- `bot/services/llm.py` интеграция с LLM и логика генерации SQL
- `infrastructure/database/connection.py` подключение к PostgreSQL
- `infrastructure/database/query_executor_db.py` выполнение SQL
- `infrastructure/load_data/` загрузка данных
- `migrations/create_tables.py` миграции/создание таблиц
